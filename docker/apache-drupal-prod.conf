<VirtualHost *:80>
    DocumentRoot /var/www/html/web
    ServerName interledger.org
    
    <Directory "/var/www/html/web">
        AllowOverride All
        Require all granted
        Options -Indexes +FollowSymLinks -MultiViews
        
        # Enhanced security headers for production
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options SAMEORIGIN
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
        
        # Content Security Policy (adjust as needed for your site)
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-src 'self' https://podcast.interledger.org;"
        
        # HSTS (HTTP Strict Transport Security) - Cloud Run handles HTTPS
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    </Directory>
    
    # Enable compression for better performance
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE text/javascript
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
    </IfModule>
    
    # Cache static assets for better performance
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 1 month"
        ExpiresByType image/jpeg "access plus 1 month"
        ExpiresByType image/gif "access plus 1 month"
        ExpiresByType image/png "access plus 1 month"
        ExpiresByType image/webp "access plus 1 month"
        ExpiresByType image/svg+xml "access plus 1 month"
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/pdf "access plus 1 month"
        ExpiresByType text/javascript "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType application/x-javascript "access plus 1 month"
        ExpiresByType application/x-shockwave-flash "access plus 1 month"
        ExpiresByType image/x-icon "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"
        
        # Don't cache dynamic PHP files
        ExpiresByType text/html "access plus 0 seconds"
        ExpiresByType application/json "access plus 0 seconds"
    </IfModule>
    
    # Cache-Control headers for static assets
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=2592000"
    </LocationMatch>
    
    # Deny access to sensitive Drupal files (but allow index.php and other entry points)
    <FilesMatch "\.(engine|inc|install|make|module|profile|po|sh|.*sql|theme|twig|tpl(\.php)?|xtmpl|yml|yaml)$">
        Require all denied
    </FilesMatch>
    
    # Deny access to backup files
    <FilesMatch "\.php(~|\.sw[op]|\.bak|\.orig|\.save)$">
        Require all denied
    </FilesMatch>
    
    # Deny access to composer files
    <FilesMatch "^composer\.(json|lock)$">
        Require all denied
    </FilesMatch>
    
    # Deny access to hidden files (except .well-known for Let's Encrypt, etc.)
    <FilesMatch "^\.(?!well-known)">
        Require all denied
    </FilesMatch>
    
    # Deny access to .git directories
    <DirectoryMatch "/\.git">
        Require all denied
    </DirectoryMatch>
    
    # Deny access to vendor directory
    <DirectoryMatch "/vendor">
        Require all denied
    </DirectoryMatch>
    
    # Block access to configuration and sensitive directories
    <DirectoryMatch "/(config|tmp|vendor|tests)">
        Require all denied
    </DirectoryMatch>
    
    # Optimized logging for production/Cloud Run
    # Cloud Run captures stdout/stderr, so we can use that
    ErrorLog /dev/stderr
    CustomLog /dev/stdout combined
</VirtualHost>

# Hide server information for security (global directives)
ServerTokens Prod
ServerSignature Off